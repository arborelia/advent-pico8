pico-8 cartridge // http://www.pico-8.com
version 34
__lua__
#include advent.p8

-- base 5 math --

-- a and b are lists of digits
-- from most to least significant
-- like {4,2,0} means 420
--
-- return true if a < b
function digits_less(a, b)
 -- right-align the numbers
 local size=max(#a, #b)
 local a_pad = {}
 local b_pad = {}
 for i=1,size do
  local apos = (#a)-(size-i)
  local bpos = (#b)-(size-i)
  if a[apos] == nil then
   a_pad[i] = 0
  else
   a_pad[i] = a[apos]
  end
  if b[bpos] == nil then
   b_pad[i] = 0
  else
   b_pad[i] = b[bpos]
  end
 end
 for i=1,size do
  if (a_pad[i] < b_pad[i]) return true
  if (a_pad[i] > b_pad[i]) return false
 end
 return false
end

function insertion_sort(a)
 for i=1,#a do
  local j = i
  while j > 1 and digits_less(a[j], a[j-1]) do
   a[j],a[j-1] = a[j-1],a[j]
   j = j - 1
  end
 end
end

function digit_str(a)
 s = ""
 for i=1,#a do
  s ..= a[i]
 end
 return s
end

-- finds an incorrectly matched
-- bracket. if there is one,
-- returns the "score".
-- if it's correctly matched
-- or just incomplete, returns 0
function match_brackets(s)
 local stack={}
 for i=1,#s do
  local ch=sub(s,i,_)
  if ch==")" then
   if stack[#stack] == "(" then
    stack[#stack] = nil
   else
    return {}
   end
  elseif ch=="]" then
   if stack[#stack] == "[" then
    stack[#stack] = nil
   else
    return {}
   end
  elseif ch=="}" then
   if stack[#stack] == "{" then
    stack[#stack] = nil
   else
    return {}
   end
  elseif ch==">" then
   if stack[#stack] == "<" then
    stack[#stack] = nil
   else
    return {}
   end
  else
   -- this is an open bracket
   -- put it on the stack
   add(stack, ch)
  end
 end
 
 -- return the rest of the stack
 -- as an array in base 5
 local score={}
 for i=#stack,1,-1 do
  local value=0
  if (stack[i] == "(") value=1
  if (stack[i] == "[") value=2
  if (stack[i] == "{") value=3
  if (stack[i] == "<") value=4
  assert(value != 0) 
  add(score, value)
 end
 return score
end

function median_score(lines)
 local scores={}
 for l in all(lines) do
  local score=match_brackets(l)
  if #score != 0 then
   print(digit_str(score))
   add(scores, score)
  end
 end
 color(10)
 print("completed "..#scores.." lines")
 return digit_str(median(scores))
end

function test_brackets(s, score)
 local result=match_brackets(s)
 test(digit_str(result), score)
end

test(digits_less({6,9}, {4,2,0}), true, "69 < 420")
test(digits_less({1,0}, {0}), false, "10 > 0")
test(digit_str({1,2,3}), "123")
test_brackets("{([(<{}[<>[]}>{[]{[(<()>", "")
test_brackets("[({(<(())[]>[[{[]{<()<>>", "33221312")
test_brackets("[(()[<>])]({[<{<<[]>>(", "134231")
test_brackets("<{([{{}}[<[[[<>{}]]]>[]]", "2134")
check(median_score(read_lines()))
__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__label__
77007070777077707770770077007700770077007770770077707770770000000000000000000000000000000000000000000000000000000000000000000000
07007070007000700070070007000700070007000070070000700070070000000000000000000000000000000000000000000000000000000000000000000000
07007770077007707770070007000700070007000770070007707770070000000000000000000000000000000000000000000000000000000000000000000000
07000070007000707000070007000700070007000070070000707000070000000000000000000000000000000000000000000000000000000000000000000000
77700070777077707770777077707770777077707770777077707770777000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77707700777070707770707077707070777077707770777077707770000000000000000000000000000000000000000000000000000000000000000000000000
00700700007070700070707000707070007000700070007000700070000000000000000000000000000000000000000000000000000000000000000000000000
77700700077077700770777007707770077007707770077077700770000000000000000000000000000000000000000000000000000000000000000000000000
70000700007000700070007000700070007000707000007070000070000000000000000000000000000000000000000000000000000000000000000000000000
77707770777000707770007077700070777077707770777077707770000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77007770707077007770777077707700707070707700777077707700000000000000000000000000000000000000000000000000000000000000000000000000
07000070707007000070007000700700707070700700007000700700000000000000000000000000000000000000000000000000000000000000000000000000
07007770777007000770077007700700777077700700777077700700000000000000000000000000000000000000000000000000000000000000000000000000
07007000007007000070007000700700007000700700700070000700000000000000000000000000000000000000000000000000000000000000000000000000
77707770007077707770777077707770007000707770777077707770000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
70707770777077707700777070707700707077007770777077707070000000000000000000000000000000000000000000000000000000000000000000000000
70700070007000700700007070700700707007000070007000707070000000000000000000000000000000000000000000000000000000000000000000000000
77707770777077700700077077700700777007007770077007707770000000000000000000000000000000000000000000000000000000000000000000000000
00707000700070000700007000700700007007007000007000700070000000000000000000000000000000000000000000000000000000000000000000000000
00707770777077707770777000707770007077707770777077700070000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77707770770070707770777077007770707077707070770070707700000000000000000000000000000000000000000000000000000000000000000000000000
00700070070070700070007007000070707000707070070070700700000000000000000000000000000000000000000000000000000000000000000000000000
07700770070077707770077007007770777007707770070077700700000000000000000000000000000000000000000000000000000000000000000000000000
00700070070000707000007007007000007000700070070000700700000000000000000000000000000000000000000000000000000000000000000000000000
77707770777000707770777077707770007077700070777000707770000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77007700707077007770777077007770777077707070777000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000700707007000070007007000070007000707070007000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000700777007000770777007007770777077707770777000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000700007007000070700007007000700070000070700000000000000000000000000000000000000000000000000000000000000000000000000000000000
77707770007077707770777077707770777077700070777000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77007700777077707770777070707770770077707700770077000000000000000000000000000000000000000000000000000000000000000000000000000000
07000700007000700070007070700070070000700700070007000000000000000000000000000000000000000000000000000000000000000000000000000000
07000700777077707770077077707770070007700700070007000000000000000000000000000000000000000000000000000000000000000000000000000000
07000700700070007000007000707000070000700700070007000000000000000000000000000000000000000000000000000000000000000000000000000000
77707770777077707770777000707770777077707770777077700000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77707700777077707070770077707770777077007070707077007070000000000000000000000000000000000000000000000000000000000000000000000000
00700700007000707070070000700070007007007070707007007070000000000000000000000000000000000000000000000000000000000000000000000000
07700700777007707770070077700770777007007770777007007770000000000000000000000000000000000000000000000000000000000000000000000000
00700700700000700070070070000070700007000070007007000070000000000000000000000000000000000000000000000000000000000000000000000000
77707770777077700070777077707770777077700070007077700070000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77007770707077707700707077707070707070707700770077007700707000000000000000000000000000000000000000000000000000000000000000000000
07000070707000700700707000707070707070700700070007000700707000000000000000000000000000000000000000000000000000000000000000000000
07000770777077700700777007707770777077700700070007000700777000000000000000000000000000000000000000000000000000000000000000000000
07000070007070000700007000700070007000700700070007000700007000000000000000000000000000000000000000000000000000000000000000000000
77707770007077707770007077700070007000707770777077707770007000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77007770707077707700777077007770777070707770707077707700000000000000000000000000000000000000000000000000000000000000000000000000
07000070707000700700007007000070007070700070707000700700000000000000000000000000000000000000000000000000000000000000000000000000
07007770777077700700777007000770077077700770777007700700000000000000000000000000000000000000000000000000000000000000000000000000
07007000007070000700700007000070007000700070007000700700000000000000000000000000000000000000000000000000000000000000000000000000
77707770007077707770777077707770777000707770007077707770000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77707070777077707070770077707770777077007770777077707700000000000000000000000000000000000000000000000000000000000000000000000000
00707070007000707070070000700070007007000070007000700700000000000000000000000000000000000000000000000000000000000000000000000000
77707770077077707770070077700770777007007770777077700700000000000000000000000000000000000000000000000000000000000000000000000000
70000070007070000070070070000070700007007000700070000700000000000000000000000000000000000000000000000000000000000000000000000000
77700070777077700070777077707770777077707770777077707770000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77707070770070707770777077700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00707070070070700070007000700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07707770070077700770077077700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700070070000700070007070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77700070777000707770777077700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77707070770077707770707077007700777077707770777077007770000000000000000000000000000000000000000000000000000000000000000000000000
00707070070000700070707007000700007000700070007007000070000000000000000000000000000000000000000000000000000000000000000000000000
07707770070077707770777007000700077007707770077007000770000000000000000000000000000000000000000000000000000000000000000000000000
00700070070070007000007007000700007000707000007007000070000000000000000000000000000000000000000000000000000000000000000000000000
77700070777077707770007077707770777077707770777077707770000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77707770777070707770777077007770777077707700707077007770000000000000000000000000000000000000000000000000000000000000000000000000
00700070007070700070007007000070007000700700707007000070000000000000000000000000000000000000000000000000000000000000000000000000
07707770077077700770777007000770077077700700777007007770000000000000000000000000000000000000000000000000000000000000000000000000
00707000007000700070700007000070007070000700007007007000000000000000000000000000000000000000000000000000000000000000000000000000
77707770777000707770777077707770777077707770007077707770000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
70707700707077707770777077707700777077707770707077707770000000000000000000000000000000000000000000000000000000000000000000000000
70700700707000700070007000700700007000700070707000700070000000000000000000000000000000000000000000000000000000000000000000000000
77700700777077700770777007700700777077700770777077707770000000000000000000000000000000000000000000000000000000000000000000000000
00700700007070000070700000700700700070000070007070007000000000000000000000000000000000000000000000000000000000000000000000000000
00707770007077707770777077707770777077707770007077707770000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
70707770770077707070770077707770777077707770770070707700707000000000000000000000000000000000000000000000000000000000000000000000
70700070070000707070070000700070007000700070070070700700707000000000000000000000000000000000000000000000000000000000000000000000
77700770070007707770070077707770077007707770070077700700777000000000000000000000000000000000000000000000000000000000000000000000
00700070070000700070070070007000007000707000070000700700007000000000000000000000000000000000000000000000000000000000000000000000
00707770777077700070777077707770777077707770777000707770007000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
70707770707077707070707077007700770077707770770077000000000000000000000000000000000000000000000000000000000000000000000000000000
70700070707000707070707007000700070000700070070007000000000000000000000000000000000000000000000000000000000000000000000000000000
77707770777077707770777007000700070007700770070007000000000000000000000000000000000000000000000000000000000000000000000000000000
00707000007070000070007007000700070000700070070007000000000000000000000000000000000000000000000000000000000000000000000000000000
00707770007077700070007077707770777077707770777077700000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
70707070777077707770777077707700777077707770777077007700000000000000000000000000000000000000000000000000000000000000000000000000
70707070007000700070007000700700007000700070007007000700000000000000000000000000000000000000000000000000000000000000000000000000
77707770777077707770077077700700777007700770077007000700000000000000000000000000000000000000000000000000000000000000000000000000
00700070700070007000007070000700700000700070007007000700000000000000000000000000000000000000000000000000000000000000000000000000
00700070777077707770777077707770777077707770777077707770000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0aa00aa0aaa0aaa0a000aaa0aaa0aaa0aa000000aaa0aaa00000a000aaa0aa00aaa00aa000000000000000000000000000000000000000000000000000000000
a000a0a0aaa0a0a0a000a0000a00a000a0a00000a000a0000000a0000a00a0a0a000a00000000000000000000000000000000000000000000000000000000000
a000a0a0a0a0aaa0a000aa000a00aa00a0a00000aaa0aaa00000a0000a00a0a0aa00aaa000000000000000000000000000000000000000000000000000000000
a000a0a0a0a0a000a000a0000a00a000a0a0000000a000a00000a0000a00a0a0a00000a000000000000000000000000000000000000000000000000000000000
0aa0aa00a0a0a000aaa0aaa00a00aaa0aaa00000aaa0aaa00000aaa0aaa0a0a0aaa0aa0000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0bb0b0b0bbb00bb0b0b00000bbb0bb000bb0b0b0bbb0bbb000000000bbb0bb00bb00bbb0bbb0bb00bbb0bbb0bbb0bb00bbb0bbb0bb00bbb00000000000000000
b000b0b0b000b000b0b00000b0b0b0b0b000b0b0b000b0b00b00000000b00b000b0000b000b00b0000b000b000b00b0000b000b00b0000b00000000000000000
b000bbb0bb00b000bb000000bbb0b0b0bbb0b0b0bb00bb0000000000bbb00b000b000bb0bbb00b00bbb0bbb00bb00b00bbb0bbb00b000bb00000000000000000
b000b0b0b000b000b0b00000b0b0b0b000b0bbb0b000b0b00b000000b0000b000b0000b0b0000b00b000b00000b00b00b000b0000b0000b00000000000000000
0bb0b0b0bbb00bb0b0b00000b0b0b0b0bb00bbb0bbb0b0b000000000bbb0bbb0bbb0bbb0bbb0bbb0bbb0bbb0bbb0bbb0bbb0bbb0bbb0bbb00000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000


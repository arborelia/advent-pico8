pico-8 cartridge // http://www.pico-8.com
version 34
__lua__
#include advent.p8
#include serial.p8

-- a kinda continuous looking
-- color scale
scale = {[0]=0,1,13,4,8,14,9,10,6,7}

function insertion_sort_back(a)
 for i=1,#a do
  local j = i
  while j > 1 and a[j-1] < a[j] do
   a[j],a[j-1] = a[j-1],a[j]
   j = j - 1
  end
 end
end

-- work with a big global array
-- at memory address 0 to 0x2000
function put(x,y,val)
 poke(y*128 + x, val)
end

function get(x,y)
 return peek(y*128 + x)
end

-- draw the input on the screen
-- and also store it in the
-- big global array
function plot(lines)
 cls(0)
 for row=1,#lines do
  local y=row-1
  local heights=split(lines[row], "")
  for col=1,#heights do
   local x=col-1
   local h=heights[col]
   pset(x,y,scale[h])
   put(x,y,h)
  end
 end
 cursor(0,104)
end

function find_basins(lines,width,height)
 plot(lines)

 -- flood fill a basin and
 -- return its size
 function fill_basin(startx,starty)
  local size=0
  -- build up a queue
  local q={{x=startx,y=starty}}
  local qpos=0
  local qend=1
  
  -- add a point to the fill
  -- queue and mark it in
  -- dark green
  function fill(x,y)
   qend += 1
   q[qend] = {x=x,y=y}
   pset(x,y,3)
   put(x,y,9)
   size += 1
  end
  while qpos < qend do
   qpos += 1
   
	  -- get the front of the queue
	  local item=q[qpos]
	  assert(type(item) == "table", type(item))
	  local x=q[qpos].x
	  local y=q[qpos].y
	  q[qpos] = nil
	  
	  if x > 0 then
	   if (get(x-1,y) < 9) fill(x-1,y)
	  end
	  if y > 0 then
	   if (get(x,y-1) < 9) fill(x,y-1)
	  end
	  if x < width-1 then
	   if (get(x+1,y) < 9) fill(x+1,y)
	  end
	  if y < height-1 then
	   if (get(x,y+1) < 9) fill(x,y+1)
	  end
  end
  return size
 end -- end of flood fill func

 local basins={}
 for x=0,width-1 do
  for y=0,height-1 do
   local valley=true
   local v=get(x,y)
   if x > 0 then
    if (v >= get(x-1,y)) valley=false
   end
   if y > 0 then
    if (v >= get(x,y-1)) valley=false
   end
   if x < width-1 then
    if (v >= get(x+1,y)) valley=false
   end
   if y < height-1 then
    if (v >= get(x,y+1)) valley=false
   end
   if valley then
    pset(x,y,11)
    local bsize=fill_basin(x,y)
    add(basins, bsize)
    if (bsize >= 90) pset(x,y,10)
    flip()
   end
  end
 end
 return basins
end

function largest_basins(lines)
 local width=#lines[1]
 local height=#lines
 local basins=find_basins(lines,width,height)
 
 insertion_sort_back(basins)
 return {basins[1],basins[2],basins[3]}
end

function basin_product(lines)
 local largest=largest_basins(lines)
 local prod=minify(largest[1]) * largest[2] * largest[3]
 return inttext(prod)
end

example = [[2199943210
3987894921
9856789892
8767896789
9899965678]]

exlines = split(example,"\n",false)
test(
 largest_basins(exlines),
 {14,9,9},
 "small example"
)
test(
 basin_product(exlines),
 "1134",
 "small example product"
)
check(basin_product(read_lines()))
__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700ddd000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0007700044400eee0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000888009990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0070070000000aaa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000006660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000007770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__label__
3333333373337776a9e8d1d48e9a676767d1d477776a9e849a774d4e976a9a676a9e4d48e9a674896784769e848e76a9848e0000000000000000000000000000
333333373337377766a94848e76776a7a67017667776a9e8e9a671d47678e967776a66ae9a674d46767d76a9e8e76a9ed1d40000000000000000000000000000
3333333373733733776a8e9aa676a9989a6777aa67776a9e9a6710176a748ea677767779a774d1d49a67e76a6e9a7ae8401d0000000000000000000000000000
3333333377373333377669a6676a9e8d8977a9e9a674767aa774d176a9ed489a6777776a679e9018e7778476a9a7479ed1840000000000000000000000000000
3333333773333333377777677776a9d1d7676e8e971d77677678876a9e81d8e9a679677677a9e8d476767d176a67d76e84e80000000000000000000000000000
33337373377333337776ae7a77776a8476a9e848e7d76a976a6776a9e8401499a67ea9e7a677a8476a6a670d767714779e9e0000000000000000000000000000
77333737777333376a98e8e9a676a9e87a9984d9a677ae84d9a6776a94d1d48e9678e84a9a667e77a9e9a67777a67e76a9a90000000000000000000000000000
37337337333733337784d489a777769a76ee4d1e9a67ae4d1e677776a848e9aaa78484d48e9a7769984e99a67e9a77776a6a0000000000000000000000000000
3377733333337333767d1d4e9a6797a76784d108e9a76784d49a67779e8eaa67674d101489a76a9ee4d48ea777a7667676760000000000000000000000000000
33733333333337376ae101d67678e767a6784d148a7776e848e6777769e9a6707774e4de9a6779e84d1d4e9a7676a9ea67470000000000000000000000000000
33373333333773337e8d1d9a67a967769a67747876776a9e8e9a676a7aaa67d1d7677848e7776a9e84d48e976a77778674d40000000000000000000000000000
37733333333337376784d8e9776a7d07767667676784766796a677a976767e8476a7678e9a677679a7a9e976a9676677e81d0000000000000000000000000000
7333333333333376a7e86a9a6776741d476aa6a9a671d776a767767e476769e87a9ea677a677776a767a976a9eaeaa6784d80000000000000000000000000000
373333333333376a9a7e76a67a67e898776e976e9a70767767776a94d4a67a97678499a677a677776a67a779e8e8e9a678e90000000000000000000000000000
33733333333776a9e779a76789a797a76a984d48e6776a9e7a76a9e101ee9776a84d8e9a679a6776a9a7767e84d48e9a7e9a0000000000000000000000000000
333737333373377e8a677871487676777764d1d8e776a9e8e9a7e84d1d48676a9e8ee7a77aea6776ae8a6a774d1d48e676a60000000000000000000000000000
33337733337376a649a674d0176a6a6777ae104e9a679e848e76a984d88e9a76a9e9a679a98e976a9849e9a678848e9a67670000000000000000000000000000
33333773377767e4de9a67d17679e9a67769d1a97677a84d49a76a9e4e67a6776a6a679e98487669e4d48e677ae899a67a7e0000000000000000000000000000
337373737776a9e8486778476a9e867776784d9a67776e848e7776a989a6779676767e84d1d76a9a841d4ea6769e9a6769480000000000000000000000000000
3337337737776a996e9a678776a9ea776a9e88e77476a9a76a678766ea67e8e7a76779e8444876e84d04ea6776a9a67a9e870000000000000000000000000000
33337733337376a776a67776777aa77676a9a9967d176a6776784e77967e847a9e976a9e8e7e979e8d1d9a79e7676776a7760000000000000000000000000000
33377333337377677767776a9a76776a976a7a67810177776784d476a7e84d76a6a67679776776a9e9a6767e8e777017767a0000000000000000000000000000
3377733333333377767176a9e6770179e47676774d177676a9e9e8e7767910176777776767a6776a6a67e74d487778d76a990000000000000000000000000000
37773333333337776a1017669677776a4d17879674767a776a9a9776aa67ddd4798976aa9e976776767e84d1076a67487e8e0000000000000000000000000000
73373333333333776e4d7676a67a677e870148e9a76a69677676766ae9a6774778476a99e889a6777776e8487679677e76a90000000000000000000000000000
7373333333373776a9876a9767e9a7a9767d8e9776a98ea777a76a9e848ea6766776a9e84d4e9a67767a9e776a9eaa67777a0000000000000000000000000000
3337333333377337a9e979e9748e96776a67e976a7684e9a679e77a9eee96789a6776674d1d4a6777a77a76a9a98e9a677760000000000000000000000000000
33737373333337376a97684d1d48ea76a9a6776a9ee8d8e9a678476a99a6784e977777678d4e977769a676a9e4d48e9a67670000000000000000000000000000
37333773333377777676a6e801d4976ae89a67a9e84d14e9677e8e767a6784d8e9a676a77489a676ae9a76a9e848e9a676a60000000000000000000000000000
733333373337776777679e84da67a7768de9a67a9e8ed8e9a767e9a767767d199a67779a67ea776ae8e9a7679eea9a677a9a0000000000000000000000000000
3737333373776a98a9a679e84ea67d17848e677679ee8e967aa77a76a67a6748e97769e9a79a679e848e9a76a696a77ea9e90000000000000000000000000000
3373773337676ae48e976aa98e97770768e971d7d76ae9a6799a67769a69a67a9767ae8e967677a71de9776777a677a8d48e0000000000000000000000000000
3333737376a9e84d48e67676a9677676ae9a677748766a67d8e9766a848ea77776a9e84867776a7674976a9a67676a941d490000000000000000000000000000
3333333777769e898e9a67776a677a6767a777667e97767d14976a79ed48e677776a94d4a677a96a6776a9e9a67776e84e8a0000000000000000000000000000
333333737337696a69a67767767769e9776776aa67a76784d8e979e8408e9a676a77688e97669e99a67777848777a7a9e9e90000000000000000000000000000
3333373333337a767677eaa6776a9e8e9a776999a676a9ea9e9a769ad1da6776a976a9e976a6d48e9677667de9a7976a9a670000000000000000000000000000
337373333333767777848e9a67767948a76a98ee97776a96aa67776a8d46776a9e876a976a9a1d48e76aaa679a67e976a6700000000000000000000000000000
37373333333337337d1d48e9a6776a8e9a784d48e97776a7677676a9e9e9769e84d176a7a9e901de76a9e976a6718ea767ed0000000000000000000000000000
73377773333333337101d48a671077a9676a948e9a6777677e9a676a969a6779e840d7769e8d1d476a9e8e67678d49777e840000000000000000000000000000
333377333333333337dd48e67771d76776a9e8a9a677677d48777677a6a6776a9ee84e7769844e8e76a9e9a67ae78776a9e90000000000000000000000000000
3333733333333337784489a777674877a76a9e9a6777a941d7667ae76767d177a79a876a7ae88e9a677a9a67d77676776a9a0000000000000000000000000000
3333373333333337a9e8ea6776a77e7a9e76a96777769ed076aa6784747d107676a677697696a9a67876a67d076a9a6776a60000000000000000000000000000
33333373333333776a9e96776a9a67678417677776a9e8476e99a67d1d87d76a67676a9e87a76a67d4e767a776a9e9a677670000000000000000000000000000
333373773333377776a67776a9e8e9a678d47677776a9e76a88e9a6701e676a9a67977684767767101d47a976a6a8e9a76760000000000000000000000000000
3333373333337667776777677aa486779e476a667776a76a94d4a6777a9a676767ae76a9897777677d48678479e84de67a9a0000000000000000000000000000
3333337373337a976a7776ae7676e9a67976a9e9a77776a9e8148e9a677677777a98477aea676a9a678ea67d76a984876ae90000000000000000000000000000
333333373737a9e9e9a76ae8e76a9a676a769e8e9a67776a94d8976777a7767a9ee8d476767476e9a6776701d7a9e8767e480000000000000000000000000000
333333373377678489a679848e7676767677e8d4a6777676a849a6776a967a67e84018e7774d1d8e9a67771d47669e7a64d40000000000000000000000000000
7337337333337371d48a674d48e7776ae76a9a98a7776a976e6a6776a9e9e9a798d1d8e767d10148e9a77674e976a779ed1d0000000000000000000000000000
737737333333733798e9a7d17a97679e8e7676ae9a67a9ee7a77776a9e848ea679448e77a99d1d896a677a677a6776ae84d40000000000000000000000000000
7733737733373333769767476776a6e848e797a9a67a6e8476771d79e84d49e9a788e76a9e84d4967676a9a7677d0769e9480000000000000000000000000000
37333333737333333776777a9e979e84d1d8e76a6769e84d47a6776a9e91d48e96779a76a9e848a777779e76a674777a7a670000000000000000000000000000
3333333733373333776a6767e876aa9a4d4e967676776e8e8e978477a96848e9779676776aa9a66776a9e8a69a77677767770000000000000000000000000000
333333337337373776a9e9a674d766a68e8e9a679a76a9a6e9a67d476aae8a9a67ea67d0767a677a779e84e8e676a6a9a7670000000000000000000000000000
333333377337737776ae8e9a67487767e9e9a679e9476a67a677d1d4766ae9767489a677777677a9a774d1d4877a9a9e96a60000000000000000000000000000
3333333337737376aa9848a67989a7767a9a676e84d07677674d101d476a96774d8a77767767678e9a67107876a9e9489a9a0000000000000000000000000000
33333333733373379e8ed977677a767a67a676a9e84767777e8441d48e76a79e8e979e9a76a9a848e9767767776a8d1de8e90000000000000000000000000000
7333333337333776e84d1a679a676a89a67717679e76a676a9a8ed48e77767a9a67a98e7779e84d48e9a67a677776401d48e0000000000000000000000000000
373733337333776a9e8101d8e9767948ea6701776a6796676a6ea6777677776a6779848677a76a88e677769a6776a71d48e70000000000000000000000000000
3373773733333377a9a4d448767a9ed4e9a67d487776e9a7767967767a6784767a67e8e9767679e99a776ae9677698d48ea60000000000000000000000000000
3333337333333337676a48e9a76a9848e677849e76a98e6a776a776a69677d07e9a79ea76a9a6796a76a9e8ea77a9e4879770000000000000000000000000000
3333333733333333776e8e9a677a9e9e9a67e8e76a9a48e9677676a9ae9a67148ea67a76a9e9a677677ae848ea67a77767670000000000000000000000000000
333373733333337376a9e9a67d76a9a6a6777e76a9e8d48e7777779848e974d489a7676aae8e9a677769e8d489a67666a9a70000000000000000000000000000
3337377733333767676a9a67d1d7676767776777779d18e9a6776a9e89aa6748ea76a679e848e9a6777a9d101e676aaa9e760000000000000000000000000000
33733333733376a9a676a677707777767776a6677674d49a778476aa676676ee976a9a6784de9a67776e844d48e7699e98e90000000000000000000000000000
3733333373376a9e977767776767776a76a9e9a76a6778e6777e977671776a967676e7677e48a67d76a9e884e77a9e84d48e0000000000000000000000000000
737733337376a9e89a677776a9aa67a9876e8476a99767971767a677707677a76a6e8ea6679e9701d76a96e876a9e84d1d480000000000000000000000000000
3373773737776a847679a6779e89a67676a98d77a8e9a6710ea76777676a9676a9e848e9a679a6794876679ea76a9ed101e90000000000000000000000000000
3333337333776ae767676776a76a7747976ae76a9e9a674d48967176a6a9ea679e84d48a6777679e89a776a77677684d1d4a0000000000000000000000000000
3333333777377676a6a67777677674d4877a9a76aaa6778489a710769a8e89a76ae8e976777676a9e7674776a97a9e94d4660000000000000000000000000000
333333773737777e9e9a676a77679e777676a677666776789767776ae84d4e97767a9a67a76a67679771d476ae76a9e8e9a60000000000000000000000000000
733377773333376898e6a679e9a7776a9a676748777a9a67a67767a984d1d976a776a67e9e79a677767d47aa98e776996a670000000000000000000000000000
37377733333379a4d48e97678e9a6776e97774d87679e9a67776a9e84d10176a984767e848ee67776a67769ea48e97a776760000000000000000000000000000
337373333337784d1d4996a679a676a98e9671076ae84e6741d76a9e84d176a9e4d4767d1d48e776e9a777e84d48e767d78a0000000000000000000000000000
33333733337337d101d48e9a6767777149a67476a9e4d4767d7776799e8d4776e81d4974d88e96798e76779e848e9a701d490000000000000000000000000000
333773333333337d44e8e9677676776ae67777776a9d176a9767676aa9e9a76a94d48e6747e9a677497a76a9e8e9a677848e0000000000000000000000000000
3373333333333784e8ee9a67ea9a777a9a76767776a47676e8a9a67666a67e76a8e869a6767a677677a9e7769a9a67a678ea0000000000000000000000000000
33373337337377e89e99a67848e9a676676a9a6777776a9a848e9777776748776a9eaa676a67776a76784d1776a67e979e960000000000000000000000000000
333777333333337ea76a6784d48e976776a9e9a6777679e84de9a67ae970d76776776778e9a67a9eaa67e4877767a9a677a70000000000000000000000000000
73733733333777a9677679e81448e9a6777e8e67776a679ed148e7e8476776a6e74879848e9a67e8e9a679e67e77676776760000000000000000000000000000
373337773777776a71d764d101d48e6776a9e9a679a9767410d4897787a76a9e84d76ae9e9a67e848e96779a78e977776a6a0000000000000000000000000000
33337337377377767076a84d1d49a977777696779e8e9a67d148e9a67a9679e84d10769a9a674d1d48e9a677679a6776a9a90000000000000000000000000000
3337333373337777e76a9e84d48e9a767767779ea84e977848ee9a67eee97a7984d767a6a679e84e8e9a6776a67677779e8e0000000000000000000000000000
33733333333333784d77a9e84a96a76a6aaa67e8e4d9767e9e9a6674848a6767e976a767676a9e8ee9a67a9e9a671769e8480000000000000000000000000000
3373733333333374d1777a9e86a676a9e9e97e84d1017a67a676774d1d48e9a67a779a7e7a766ae7a667a7e8e774d76a94d10000000000000000000000000000
33733333333337e847a66779e777779e8a8e77e84d7769a777779e84848a67677769ed48e9a77797677a9e848e6776764d100000000000000000000000000000
3733333333337a977a9aaa679a6776e84148a67987677e9a6776a9e8e8e9a676776e848e6a6776a67777e84de9a76a9e84d40000000000000000000000000000
3773333333333776a9e9e9a676776a9e8e8e9a67e7a698ea67776a9e9e6a679a76a967e976748767976a9e846a677679e9480000000000000000000000000000
7733333333373776ae848977777676a9e9e9a677769e84e96776776a677678e7776a7a9a671d4779847669a8e7769776ae8e0000000000000000000000000000
337333377377776a984d4767776a676a7a9a67776ae84d48776a9e767777d47677767676710776a9ed477a679a678476a9a90000000000000000000000000000
3737733777776a9e84d1dea667a9a7767676776a9e84d1d46676a847a670177a677767474d76677684777676a677d107676a0000000000000000000000000000
733777777776a9e84d1048e9a67e9a6777978e77aaed101d9a679e8e9a6776a9a676a98e776a9a77e76a678777767d1877760000000000000000000000000000
3733777733376a9e84d1d49a67d4867767e848487694d1e8e9a679e9a6766a9e677776976a9ee67676a9e8476a7a77d487770000000000000000000000000000
3333337773337677e84d8aa67d187776a679d1d477a84a9e9667779a676a9e848ea767a776e848ea677a6776a9a9a67876670000000000000000000000000000
3333337773333776a9e4e9a67747676a9a674d77676e76a6777776767776ae8d4876a6776a84d49a6776776a9e4e9a676aa60000000000000000000000000000
33333333373376a779e89a67a676a9e9e9a6776aa979a7671d776a67676a9841d47a9a76a9e848a67667017668d8e9a679e90000000000000000000000000000
3333373373376a976a6e76789a7a9e848e9a67a99e7a67710769e9489a769e8077a9e9976a9e89a7e9a674e74d149a67769a0000000000000000000000000000
3333337773377ae87679a7d47769e84d48a9a67ee876767d76a98edee9676ae76a9e8ee977aae9678e9a6776810d487777a60000000000000000000000000000
333333373776a984876a67176a9eaed1d48e96784d479a776a98481d8e776a9776a9488e9a769a7848e9a76a4d148ea677670000000000000000000000000000
33333373376a9e4de9767107a9e84d1018e9a674d1d4e76a9e84d1019a6777a6776ad1d4a677a674d48e76a9e4d4e76710770000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000


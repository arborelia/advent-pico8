pico-8 cartridge // http://www.pico-8.com
version 34
__lua__
#include advent.p8
#include serial.p8

on=10
off=1

function draw_segs(row,col,bits)
 local x=col*7
 local y=row*8
 if (bits & 1 > 0) color(on) else color(off)
 line(x+4,y+1,x+4,y+2)
 if (bits & 2 > 0) color(on) else color(off)
 line(x+4,y+4,x+4,y+5)
 if (bits & 4 > 0) color(on) else color(off)
 line(x+1,y+6,x+3,y+6)
 if (bits & 8 > 0) color(on) else color(off)
 line(x,y+1,x,y+2)
 if (bits & 16 > 0) color(on) else color(off)
 line(x+1,y+3,x+3,y+3)
 if (bits & 32 > 0) color(on) else color(off)
 line(x+1,y,x+3,y)
 if (bits & 64 > 0) color(on) else color(off)
 line(x,y+4,x,y+5)
end

-- convert a string like abge
-- to bits representing the
-- segments that are on
function segbits(s)
 local n=0
 for ch in all(split(s,"")) do
  n |= shl(1,ord(ch)-ord("a"))
 end
 return n
end

function nsegs(bits)
 local n=0
 for b=0,6 do
  if bits & shl(1,b) > 0 then
   n += 1
  end
 end
 return n
end

function subset(a,b)
 return a & b == a
end

function parse_line(l)
 local parts = split(l, "|")
 local res = {examples={}, target={}}
 for digit in all(split(parts[1], " ")) do
  if digit != "" then
   add(res.examples, segbits(digit))
  end
 end
 assert(#res.examples == 10)
 
 for digit in all(split(parts[2], " ")) do
  if digit != "" then
   add(res.target, segbits(digit))
  end
 end
 assert(#res.target == 4)
 
 return res 
end

-- map these garbled digits to
-- the digits 0-9
function map_digits(digits, row)
 -- row is just for where to
 -- put it on the screen
 -- it can be nil
 if (row==nil) row=-1
 
 local mapped={
  [0]=nil,nil,nil,nil,nil,
  nil,nil,nil,nil,nil
 }
 function assign(pos,segs)
  assert(mapped[pos]==nil)
  mapped[pos]=segs
  draw_segs(row,pos,segs)
 end

 for i=1,#digits do
  local d=digits[i]
  local ns=nsegs(d)
  if ns==2 then
   assign(1,d)
  elseif ns==3 then
   assign(7,d)
  elseif ns==4 then
   assign(4,d)
  elseif ns==7 then
   assign(8,d)
  end
 end
 
 for i=1,#digits do
  local d=digits[i]
  local ns=nsegs(d)
  if ns==6 then
   if subset(mapped[4], d) then
    assign(9,d)
   elseif subset(mapped[7], d) then
    assign(0,d)
   else
    assign(6,d)
   end
  end
 end
 for i=1,#digits do
  local d=digits[i]
  local ns=nsegs(d)
  if ns==5 then
   if subset(d, mapped[6]) then
    assign(5,d)
   elseif subset(d, mapped[9]) then
    assign(3,d)
   else
    assign(2,d)
   end
  end
 end
 
 -- reverse the mapping
 local revmap = {}
 for i=0,9 do
  revmap[mapped[i]] = i
 end
 return revmap
end

function add_digits(lines)
 local total=0
 cls(0)
 for i=1,#lines do
  local parsed=parse_line(lines[i])
  local mapping=map_digits(parsed.examples, i-1)
  
  local val=0
  for j=1,4 do
   local bits=parsed.target[j]
   draw_segs(i-1,j+10,bits)
   local d=mapping[bits]
   assert(d != nil)
   val *= 10
   val += d
   color(7)
   print(d, 108+j*4, (i-1)*8)
  end
  total += minify(val)
  cursor(0, i*8)
 end
 return inttext(total)
end

test(segbits("a"), 1, "a")
test(segbits("abcdefg"), 127, "abcdefg")
test(segbits("dab"), 11, "dab")

example = "acedgfb cdfbe gcdfa fbcad dab cefabd cdfgeb eafb cagedb ab | cdfeb fcadb cdfeb cdbaf"
parsed = parse_line(example)
test(parsed.target, {62, 47, 62, 47})
test(parsed.examples[1], 127)
test(parsed.examples[10], 3)

test(nsegs(127), 7, "7 segments")
test(nsegs(17), 2, "2 segments")

test(
 add_digits({example}),
 "5353",
 "smallest example"
)

check(add_digits(read_lines()))
__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__label__
0aaa00001110000aaa0000aaa00001110000aaa0000aaa00001110000aaa0000aaa00000000000aaa0000aaa0000aaa000011100000000007770777077707070
a000a001000100a000a00a0001001000100a000100a000a00a000100a000a00a0001000000000a000a00a000100a000100100010000000007070007070707070
a000a001000100a000a00a0001001000100a000100a000a00a000100a000a00a0001000000000a000a00a000100a000100100010000000007770077077707770
0aaa0000aaa00001110000aaa0000aaa0000aaa0000aaa0000aaa0000aaa0000aaa00000000000aaa0000aaa0000aaa0000aaa00000000007070007000700070
a000a001000a001000a001000a00a000a00a000100a0001001000a00a000a00a000a000000000a000a001000a00a000a00a000a0000000007770777000700070
a000a001000a001000a001000a00a000a00a000100a0001001000a00a000a00a000a000000000a000a001000a00a000a00a000a0000000000000000000000000
011100001110000aaa0000aaa0000aaa0000aaa0000aaa00001110000aaa0000aaa00000000000aaa0000aaa0000aaa0000aaa00000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0aaa0000111000011100001110000aaa0000aaa0000aaa00001110000aaa0000aaa00000000000aaa00001110000aaa000011100000000007770777077707700
a000a001000100a000a00a0001001000100a000100a000a001000100a000a00a0001000000000a0001001000100a000a00100010000000007070007070700700
a000a001000100a000a00a0001001000100a000100a000a001000100a000a00a0001000000000a0001001000100a000a00100010000000007770007077700700
011100001110000aaa0000aaa0000aaa0000aaa0000aaa00001110000aaa0000aaa00000000000aaa00001110000aaa000011100000000000070007070700700
a000a00a0001001000a00a000a00a000100a000a00a000a00a000a00a000a00a000a000000000a000a00a000a00a000a00a00010000000000070007077707770
a000a00a0001001000a00a000a00a000100a000a00a000a00a000a00a000a00a000a000000000a000a00a000a00a000a00a00010000000000000000000000000
0aaa0000aaa0000aaa0000aaa0000aaa000011100001110000aaa0000aaa0000aaa00000000000aaa0000aaa0000aaa0000aaa00000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0aaa0000111000011100001110000aaa0000aaa0000aaa00001110000aaa0000aaa0000000000011100001110000aaa000011100000000007700770077707770
a0001001000100a000a00a000a001000a00a000a00a000a001000100a000a00a000a00000000010001001000100a000a00100010000000000700070070700070
a0001001000100a000a00a000a001000a00a000a00a000a001000100a000a00a000a00000000010001001000100a000a00100010000000000700070077700070
0aaa00001110000aaa0000111000011100001110000aaa00001110000aaa00001110000000000011100001110000111000011100000000000700070000700070
a000a00a0001001000a00a000a00a000100a000a00a000a00a000a00a000a00a000a000000000a000100a000100a000a00a000a0000000007770777000700070
a000a00a0001001000a00a000a00a000100a000a00a000a00a000a00a000a00a000a000000000a000100a000100a000a00a000a0000000000000000000000000
0aaa0000aaa0000aaa0000aaa0000aaa000011100001110000aaa0000aaa0000aaa00000000000aaa0000aaa0000aaa0000aaa00000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0aaa0000111000011100001110000aaa0000aaa0000aaa00001110000aaa0000aaa00000000000aaa00001110000aaa000011100000000007770777070007700
a0001001000100a000a00a000a001000a00a000a00a000a00a000100a000a00a000a000000000a000a00a000a00a000a00100010000000007070007070000700
a0001001000100a000a00a000a001000a00a000a00a000a00a000100a000a00a000a000000000a000a00a000a00a000a00100010000000007770077077700700
0aaa00001110000aaa0000aaa00001110000aaa0000aaa00001110000aaa0000aaa00000000000aaa0000aaa0000aaa000011100000000000070007070700700
a000a001000a00a000a001000a001000a001000100a0001001000a00a000a001000a0000000001000a001000a00a0001001000a0000000000070777077707770
a000a001000a00a000a001000a001000a001000100a0001001000a00a000a001000a0000000001000a001000a00a0001001000a0000000000000000000000000
0aaa0000aaa00001110000aaa0000aaa0000aaa0000aaa0000aaa0000aaa0000aaa00000000000aaa0000aaa0000aaa0000aaa00000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0aaa0000aaa0000aaa0000aaa0000aaa000011100001110000aaa0000aaa0000aaa00000000000aaa0000aaa0000aaa0000aaa00000000007070777077707770
a000a001000100a000a001000a0010001001000a00a000a001000100a000a001000a0000000001000100a000a0010001001000a0000000007070707000700070
a000a001000100a000a001000a0010001001000a00a000a001000100a000a001000a0000000001000100a000a0010001001000a0000000007770777000700770
011100001110000aaa0000aaa0000aaa0000aaa0000aaa00001110000aaa0000aaa00000000000aaa0000aaa00001110000aaa00000000000070707000700070
a000a00a0001001000a00a000a00a000100a000a00a000a00a000a00a000a00a000a000000000a000100a000a00a000a00a000a0000000000070777000707770
a000a00a0001001000a00a000a00a000100a000a00a000a00a000a00a000a00a000a000000000a000100a000a00a000a00a000a0000000000000000000000000
0aaa0000111000011100001110000aaa0000aaa0000aaa00001110000aaa0000aaa00000000000aaa0000aaa0000111000011100000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0aaa00001110000aaa0000aaa00001110000aaa0000aaa0000aaa0000aaa0000aaa00000000000aaa000011100001110000aaa00000000007770707077007770
a000a001000a00a0001001000a001000a001000a00a000a001000a00a000a001000a000000000a000a001000a001000a00a000a0000000007070707007007070
a000a001000a00a0001001000a001000a001000a00a000a001000a00a000a001000a000000000a000a001000a001000a00a000a0000000007770777007007770
0aaa0000111000011100001110000aaa0000aaa0000aaa00001110000aaa0000aaa00000000000aaa0000aaa00001110000aaa00000000007070007007007070
a0001001000100a000a00a000a001000a00a000a00a000a001000100a000a00a000a000000000a000a001000a001000100a000a0000000007770007077707770
a0001001000100a000a00a000a001000a00a000a00a000a001000100a000a00a000a000000000a000a001000a001000100a000a0000000000000000000000000
0aaa0000aaa0000aaa0000aaa0000aaa000011100001110000aaa0000aaa0000aaa00000000000aaa0000aaa0000aaa0000aaa00000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0aaa0000aaa00001110000aaa0000aaa0000aaa0000aaa0000aaa0000aaa0000aaa00000000000aaa0000aaa0000aaa0000aaa00000000007070777070707770
a000a001000100a000a00a0001001000100a000100a000a00a000100a000a00a00010000000001000100a0001001000100a000a0000000007070700070707070
a000a001000100a000a00a0001001000100a000100a000a00a000100a000a00a00010000000001000100a0001001000100a000a0000000007770777077707770
0aaa0000111000011100001110000aaa0000aaa0000aaa00001110000aaa0000aaa00000000000aaa0000aaa0000aaa0000aaa00000000000070007000707070
a000a00a000100a000a00a000a00a0001001000a001000a00a000100a000a00a000a000000000a0001001000a00a000100a000a0000000000070777000707770
a000a00a000100a000a00a000a00a0001001000a001000a00a000100a000a00a000a000000000a0001001000a00a000100a000a0000000000000000000000000
011100001110000aaa0000aaa0000aaa0000aaa0000aaa00001110000aaa0000aaa00000000000aaa0000aaa0000aaa0000aaa00000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0aaa0000111000011100001110000aaa0000aaa0000aaa00001110000aaa0000aaa000000000001110000aaa00001110000aaa00000000007700700077707770
a000a00a000100a000a00a000100a00010010001001000a00a000100a000a00a0001000000000a0001001000a00a000a00100010000000000700700000707000
a000a00a000100a000a00a000100a00010010001001000a00a000100a000a00a0001000000000a0001001000a00a000a00100010000000000700777077707770
0aaa0000aaa00001110000aaa0000aaa0000aaa0000aaa0000aaa0000aaa0000aaa00000000000aaa0000aaa00001110000aaa00000000000700707070000070
a0001001000100a000a00a000a001000a00a000a00a000a001000100a000a00a000a0000000001000100a000a00a000a00a000a0000000007770777077707770
a0001001000100a000a00a000a001000a00a000a00a000a001000100a000a00a000a0000000001000100a000a00a000a00a000a0000000000000000000000000
0aaa00001110000aaa0000aaa00001110000aaa0000aaa0000aaa0000aaa0000aaa000000000001110000aaa0000aaa0000aaa00000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0aaa00001110000aaa0000aaa00001110000aaa0000aaa00001110000aaa0000aaa00000000000aaa00001110000111000011100000000007770777077007770
a000a0010001001000a001000100a000100a000100a000a001000100a000a00a0001000000000a000a0010001001000100100010000000007070007007000070
a000a0010001001000a001000100a000100a000100a000a001000100a000a00a0001000000000a000a0010001001000100100010000000007770007007000070
011100001110000aaa0000aaa0000aaa0000aaa0000aaa00001110000aaa0000aaa00000000000aaa00001110000111000011100000000007070007007000070
a000a00a0001001000a00a000a00a000100a000a00a000a00a000a00a000a00a000a000000000a000a00a000a00a000100a000a0000000007770007077700070
a000a00a0001001000a00a000a00a000100a000a00a000a00a000a00a000a00a000a000000000a000a00a000a00a000100a000a0000000000000000000000000
0aaa0000aaa0000aaa0000aaa0000aaa000011100001110000aaa0000aaa0000aaa00000000000aaa0000aaa0000aaa0000aaa00000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0aaa0000aaa0000aaa0000aaa0000aaa000011100001110000aaa0000aaa0000aaa00000000000aaa0000aaa0000aaa000011100000000007070777077007770
a0001001000100a000a001000a001000a001000a00a000a001000100a000a001000a0000000001000a001000a0010001001000a0000000007070007007007000
a0001001000100a000a001000a001000a001000a00a000a001000100a000a001000a0000000001000a001000a0010001001000a0000000007770077007007770
0aaa0000111000011100001110000aaa0000aaa0000aaa00001110000aaa0000aaa00000000000aaa000011100001110000aaa00000000000070007007000070
a000a00a0001001000a00a000a00a000100a000a00a000a00a000100a000a00a000a000000000a000100a000a00a000100a000a0000000000070777077707770
a000a00a0001001000a00a000a00a000100a000a00a000a00a000100a000a00a000a000000000a000100a000a00a000100a000a0000000000000000000000000
0aaa00001110000aaa0000aaa00001110000aaa0000aaa0000aaa0000aaa0000aaa000000000001110000aaa00001110000aaa00000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0bb0b0b0bbb00bb0b0b00000bbb0bb000bb0b0b0bbb0bbb000000000b000bb00bbb0bbb0bbb00000000000000000000000000000000000000000000000000000
b000b0b0b000b000b0b00000b0b0b0b0b000b0b0b000b0b00b000000b0000b0000b000b0b0b00000000000000000000000000000000000000000000000000000
b000bbb0bb00b000bb000000bbb0b0b0bbb0b0b0bb00bb0000000000bbb00b00bbb0bbb0bbb00000000000000000000000000000000000000000000000000000
b000b0b0b000b000b0b00000b0b0b0b000b0bbb0b000b0b00b000000b0b00b00b000b00000b00000000000000000000000000000000000000000000000000000
0bb0b0b0bbb00bb0b0b00000b0b0b0b0bb00bbb0bbb0b0b000000000bbb0bbb0bbb0bbb000b00000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

